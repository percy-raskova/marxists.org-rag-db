#!/bin/bash
# Pre-commit hook for MIA RAG System
# Enforces boundary checking, secret scanning, and code quality

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# 1. Check instance boundaries
echo -e "\n${YELLOW}1. Checking instance boundaries...${NC}"
if [ -f .instance ]; then
    INSTANCE=$(cat .instance)
    echo "Instance identified: $INSTANCE"

    # Run boundary check
    if python scripts/check_boundaries.py --auto --strict; then
        echo -e "${GREEN}✅ Boundary check passed${NC}"
    else
        echo -e "${RED}❌ Boundary violations detected!${NC}"
        echo "You are modifying files outside your instance boundaries."
        echo "See INSTANCE-BOUNDARIES.md for your allowed paths."
        exit 1
    fi
else
    echo -e "${YELLOW}⚠️  No instance identified. Skipping boundary check.${NC}"
fi

# 2. Check for hardcoded secrets
echo -e "\n${YELLOW}2. Scanning for secrets...${NC}"
STAGED_FILES=$(git diff --cached --name-only)

# Patterns that might indicate secrets
SECRET_PATTERNS=(
    "RUNPOD_API_KEY"
    "GCP_KEY"
    "GOOGLE_APPLICATION_CREDENTIALS"
    "SECRET"
    "PASSWORD"
    "TOKEN"
    "API_KEY"
    "PRIVATE_KEY"
    "AWS_ACCESS_KEY"
    "AWS_SECRET"
)

for pattern in "${SECRET_PATTERNS[@]}"; do
    # Exclude certain files and directories from secret scanning
    FOUND_FILES=$(echo "$STAGED_FILES" | xargs grep -l "$pattern" 2>/dev/null | \
        grep -v ".env.example" | \
        grep -v ".gitignore" | \
        grep -v ".githooks/" | \
        grep -v "docs/rfc/" | \
        grep -v "docs/corpus-analysis/" | \
        grep -v "specs/" | \
        grep -v "scripts/check_todos.py" | \
        grep -v "docker-compose.yml" | \
        grep -v ".github/workflows/" || true)

    if [ ! -z "$FOUND_FILES" ]; then
        echo -e "${RED}❌ Potential secrets detected!${NC}"
        echo "Found pattern: $pattern in:"
        echo "$FOUND_FILES"
        echo "Never commit API keys, credentials, or secrets."
        echo "Use environment variables and .env files instead."
        exit 1
    fi
done
echo -e "${GREEN}✅ No secrets detected${NC}"

# 3. Check TODO format
echo -e "\n${YELLOW}3. Checking TODO format...${NC}"
PYTHON_FILES_FOR_TODO=$(echo "$STAGED_FILES" | grep "\.py$" || true)
if [ ! -z "$PYTHON_FILES_FOR_TODO" ]; then
    if python scripts/check_todos.py $PYTHON_FILES_FOR_TODO; then
        echo -e "${GREEN}✅ TODO format check passed${NC}"
    else
        echo -e "${RED}❌ Invalid TODO format detected!${NC}"
        echo "Use format: TODO(instance{N}): description - issue #123"
        exit 1
    fi
else
    echo "No Python files to check for TODOs"
fi

# 4. Check interface changes
echo -e "\n${YELLOW}4. Checking interface contracts...${NC}"
INTERFACE_FILES=$(echo "$STAGED_FILES" | grep "src/mia_rag/interfaces/" || true)
if [ ! -z "$INTERFACE_FILES" ]; then
    echo -e "${YELLOW}⚠️  Interface changes detected!${NC}"
    echo "Interface changes require:"
    echo "  1. RFC document in docs/rfcs/"
    echo "  2. Version bump in the interface file"
    echo "  3. 24-hour review period"

    # Check for version bump
    for file in $INTERFACE_FILES; do
        if ! git diff --cached "$file" | grep -q "__version__"; then
            echo -e "${RED}❌ Interface modified without version bump!${NC}"
            echo "File: $file"
            echo "Add or update __version__ = 'X.Y.Z' in the file"
            exit 1
        fi
    done

    echo -e "${YELLOW}Interface version bumped. Ensure RFC is created.${NC}"
fi

# 5. Run Python linting on staged files
echo -e "\n${YELLOW}5. Running Ruff linting...${NC}"
PYTHON_FILES=$(echo "$STAGED_FILES" | grep "\.py$" || true)
if [ ! -z "$PYTHON_FILES" ]; then
    if poetry run ruff check $PYTHON_FILES; then
        echo -e "${GREEN}✅ Linting passed${NC}"
    else
        echo -e "${RED}❌ Linting failed!${NC}"
        echo "Run 'poetry run ruff check --fix' to auto-fix issues"
        exit 1
    fi
else
    echo "No Python files to lint"
fi

# 6. Check file size (prevent large files)
echo -e "\n${YELLOW}6. Checking file sizes...${NC}"
MAX_FILE_SIZE=10485760  # 10MB in bytes

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        file_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
        if [ "$file_size" -gt "$MAX_FILE_SIZE" ]; then
            echo -e "${RED}❌ Large file detected!${NC}"
            echo "File: $file ($(($file_size / 1048576))MB)"
            echo "Files larger than 10MB should not be committed."
            echo "Use Git LFS or store externally."
            exit 1
        fi
    fi
done
echo -e "${GREEN}✅ File sizes OK${NC}"

# 7. Check branch naming convention
echo -e "\n${YELLOW}7. Checking branch naming...${NC}"
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$BRANCH" =~ ^(main|develop|instance[1-6]/.*|rfc/.*|release/v.*|hotfix/.*)$ ]]; then
    echo -e "${GREEN}✅ Branch naming OK: $BRANCH${NC}"
else
    echo -e "${YELLOW}⚠️  Non-standard branch name: $BRANCH${NC}"
    echo "Consider using standard naming:"
    echo "  - instance{N}/{module}-{feature}"
    echo "  - rfc/{number}-{description}"
    echo "  - release/v{version}"
    echo "  - hotfix/{description}"
fi

# 8. Check for merge conflict markers
echo -e "\n${YELLOW}8. Checking for merge conflict markers...${NC}"
CONFLICT_MARKERS="^[<>=]{7}"
if git diff --cached | grep -E "$CONFLICT_MARKERS"; then
    echo -e "${RED}❌ Merge conflict markers found!${NC}"
    echo "Resolve all conflicts before committing."
    exit 1
fi
echo -e "${GREEN}✅ No conflict markers${NC}"

# Success
echo -e "\n${GREEN}✨ All pre-commit checks passed!${NC}"
echo "Ready to commit."
exit 0