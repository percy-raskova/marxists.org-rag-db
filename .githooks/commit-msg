#!/bin/bash
# Commit message validation hook for MIA RAG System
# Enforces conventional commit format

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the commit message
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

echo -e "${YELLOW}Validating commit message format...${NC}"

# Conventional commit regex pattern
# Format: <type>(<scope>): <subject>
PATTERN="^(feat|fix|docs|test|refactor|perf|chore|style|build|ci|revert|rfc)(\([a-z0-9\-]+\))?: .{1,100}$"

# Get first line of commit message
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)

# Check if it matches the pattern
if echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    echo -e "${GREEN}‚úÖ Commit message format valid${NC}"
else
    echo -e "${RED}‚ùå Invalid commit message format!${NC}"
    echo ""
    echo "Expected format: <type>(<scope>): <subject>"
    echo ""
    echo "Types:"
    echo "  feat     - New feature"
    echo "  fix      - Bug fix"
    echo "  docs     - Documentation changes"
    echo "  test     - Test additions/changes"
    echo "  refactor - Code refactoring"
    echo "  perf     - Performance improvements"
    echo "  chore    - Build/tooling changes"
    echo "  style    - Code style changes (formatting, etc)"
    echo "  build    - Build system changes"
    echo "  ci       - CI configuration changes"
    echo "  revert   - Revert previous commit"
    echo "  rfc      - Interface change proposal"
    echo ""
    echo "Scopes (by instance):"
    echo "  Instance 1: storage, pipeline"
    echo "  Instance 2: embeddings"
    echo "  Instance 3: weaviate, vectordb"
    echo "  Instance 4: api, query"
    echo "  Instance 5: mcp"
    echo "  Instance 6: monitoring, integration, tests"
    echo ""
    echo "Examples:"
    echo "  feat(embeddings): add batch processor with checkpointing"
    echo "  fix(storage): handle GCS connection timeout"
    echo "  docs(api): update OpenAPI schema"
    echo "  test(weaviate): add integration tests"
    echo "  chore(deps): update poetry dependencies"
    echo ""
    echo "Your message: $FIRST_LINE"
    exit 1
fi

# Check for instance-specific scope
if [ -f .instance ]; then
    INSTANCE=$(cat .instance)

    # Map instance to expected scopes
    case $INSTANCE in
        instance1)
            EXPECTED_SCOPES="storage|pipeline"
            ;;
        instance2)
            EXPECTED_SCOPES="embeddings"
            ;;
        instance3)
            EXPECTED_SCOPES="weaviate|vectordb"
            ;;
        instance4)
            EXPECTED_SCOPES="api|query"
            ;;
        instance5)
            EXPECTED_SCOPES="mcp"
            ;;
        instance6)
            EXPECTED_SCOPES="monitoring|integration|tests"
            ;;
        *)
            EXPECTED_SCOPES=".*"
            ;;
    esac

    # Extract scope if present
    if echo "$FIRST_LINE" | grep -qE "^[a-z]+\([a-z\-]+\):"; then
        SCOPE=$(echo "$FIRST_LINE" | sed -E 's/^[a-z]+\(([a-z\-]+)\):.*/\1/')

        # Check if scope matches instance
        if ! echo "$SCOPE" | grep -qE "^($EXPECTED_SCOPES)$"; then
            echo -e "${YELLOW}‚ö†Ô∏è  Scope '$SCOPE' doesn't match $INSTANCE${NC}"
            echo "Expected scopes: $EXPECTED_SCOPES"
            echo "This is just a warning - proceeding with commit."
        fi
    fi
fi

# Check subject length
SUBJECT=$(echo "$FIRST_LINE" | sed -E 's/^[a-z]+(\([a-z\-]+\))?: //')
SUBJECT_LENGTH=${#SUBJECT}

if [ $SUBJECT_LENGTH -gt 100 ]; then
    echo -e "${RED}‚ùå Subject line too long!${NC}"
    echo "Subject is $SUBJECT_LENGTH characters (max 100)"
    echo "Keep the first line concise. Use the body for details."
    exit 1
fi

# Check for WIP commits
if echo "$COMMIT_MSG" | grep -qi "^wip\|work in progress"; then
    echo -e "${YELLOW}‚ö†Ô∏è  WIP commit detected${NC}"
    echo "Consider using 'git stash' for work in progress"
    echo "Or use feature branches for incomplete work"
    read -p "Continue with WIP commit? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for Claude Code co-authorship (optional but recommended)
if ! grep -q "Co-Authored-By: Claude" "$COMMIT_MSG_FILE"; then
    echo -e "${YELLOW}üí° Tip: Add co-authorship for Claude Code${NC}"
    echo "Add to commit message:"
    echo ""
    echo "ü§ñ Generated with Claude Code"
    echo "Co-Authored-By: Claude <noreply@anthropic.com>"
fi

# Check for issue references
if ! echo "$COMMIT_MSG" | grep -qE "#[0-9]+|Closes|Fixes|Related|Issue"; then
    echo -e "${YELLOW}üí° Tip: Reference related issues${NC}"
    echo "Use 'Closes #123' or 'Related to #456' in the message"
fi

echo -e "${GREEN}‚úÖ Commit message validated${NC}"
exit 0